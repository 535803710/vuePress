<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaScript 异步编程和事件循环详解 | 前端小蜗</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/vuepress/img/home.jpeg">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/vuepress/assets/css/0.styles.189cad16.css" as="style"><link rel="preload" href="/vuepress/assets/js/app.40312837.js" as="script"><link rel="preload" href="/vuepress/assets/js/2.cf1e524c.js" as="script"><link rel="preload" href="/vuepress/assets/js/13.110f8559.js" as="script"><link rel="prefetch" href="/vuepress/assets/js/10.a610a9ba.js"><link rel="prefetch" href="/vuepress/assets/js/11.f87d06bd.js"><link rel="prefetch" href="/vuepress/assets/js/12.11a58652.js"><link rel="prefetch" href="/vuepress/assets/js/14.322c46a5.js"><link rel="prefetch" href="/vuepress/assets/js/15.b2b443b5.js"><link rel="prefetch" href="/vuepress/assets/js/16.7ff17cba.js"><link rel="prefetch" href="/vuepress/assets/js/17.fc193e79.js"><link rel="prefetch" href="/vuepress/assets/js/18.52d0a4c4.js"><link rel="prefetch" href="/vuepress/assets/js/19.25f2d672.js"><link rel="prefetch" href="/vuepress/assets/js/20.c6723148.js"><link rel="prefetch" href="/vuepress/assets/js/21.74e5c0f6.js"><link rel="prefetch" href="/vuepress/assets/js/22.e6d1a64a.js"><link rel="prefetch" href="/vuepress/assets/js/23.86aba3c2.js"><link rel="prefetch" href="/vuepress/assets/js/24.3ae19470.js"><link rel="prefetch" href="/vuepress/assets/js/25.edcf91c9.js"><link rel="prefetch" href="/vuepress/assets/js/26.89319ef2.js"><link rel="prefetch" href="/vuepress/assets/js/27.9e533376.js"><link rel="prefetch" href="/vuepress/assets/js/28.93a6ba41.js"><link rel="prefetch" href="/vuepress/assets/js/29.d72f0022.js"><link rel="prefetch" href="/vuepress/assets/js/3.a5adedeb.js"><link rel="prefetch" href="/vuepress/assets/js/30.871cc77c.js"><link rel="prefetch" href="/vuepress/assets/js/31.11915659.js"><link rel="prefetch" href="/vuepress/assets/js/32.2d371a40.js"><link rel="prefetch" href="/vuepress/assets/js/33.19d049e9.js"><link rel="prefetch" href="/vuepress/assets/js/34.52633d55.js"><link rel="prefetch" href="/vuepress/assets/js/35.c77625e0.js"><link rel="prefetch" href="/vuepress/assets/js/36.ec517178.js"><link rel="prefetch" href="/vuepress/assets/js/37.e955d687.js"><link rel="prefetch" href="/vuepress/assets/js/38.a76e9c38.js"><link rel="prefetch" href="/vuepress/assets/js/39.0758c6eb.js"><link rel="prefetch" href="/vuepress/assets/js/4.7fc56b7b.js"><link rel="prefetch" href="/vuepress/assets/js/40.bfc21b26.js"><link rel="prefetch" href="/vuepress/assets/js/41.1cca45c8.js"><link rel="prefetch" href="/vuepress/assets/js/42.76b92fb2.js"><link rel="prefetch" href="/vuepress/assets/js/43.5bcb4c47.js"><link rel="prefetch" href="/vuepress/assets/js/44.0bf86704.js"><link rel="prefetch" href="/vuepress/assets/js/45.b6f1d2ae.js"><link rel="prefetch" href="/vuepress/assets/js/46.d942ba15.js"><link rel="prefetch" href="/vuepress/assets/js/47.8bb95ad0.js"><link rel="prefetch" href="/vuepress/assets/js/48.fb8ad7c2.js"><link rel="prefetch" href="/vuepress/assets/js/49.fb46b14b.js"><link rel="prefetch" href="/vuepress/assets/js/5.6ac62750.js"><link rel="prefetch" href="/vuepress/assets/js/50.49f08253.js"><link rel="prefetch" href="/vuepress/assets/js/51.7663b0cd.js"><link rel="prefetch" href="/vuepress/assets/js/52.90d8fc5a.js"><link rel="prefetch" href="/vuepress/assets/js/53.00bdcc76.js"><link rel="prefetch" href="/vuepress/assets/js/54.93e18111.js"><link rel="prefetch" href="/vuepress/assets/js/55.c887fc69.js"><link rel="prefetch" href="/vuepress/assets/js/56.0f6408ae.js"><link rel="prefetch" href="/vuepress/assets/js/57.e8334a13.js"><link rel="prefetch" href="/vuepress/assets/js/58.52393270.js"><link rel="prefetch" href="/vuepress/assets/js/59.d0661709.js"><link rel="prefetch" href="/vuepress/assets/js/6.d831054f.js"><link rel="prefetch" href="/vuepress/assets/js/60.0b34950f.js"><link rel="prefetch" href="/vuepress/assets/js/61.13e9f684.js"><link rel="prefetch" href="/vuepress/assets/js/62.caee8c5c.js"><link rel="prefetch" href="/vuepress/assets/js/63.a22fbd8d.js"><link rel="prefetch" href="/vuepress/assets/js/64.d8204a06.js"><link rel="prefetch" href="/vuepress/assets/js/65.4d094f10.js"><link rel="prefetch" href="/vuepress/assets/js/66.b4582d16.js"><link rel="prefetch" href="/vuepress/assets/js/67.93aa23db.js"><link rel="prefetch" href="/vuepress/assets/js/68.b57ddd04.js"><link rel="prefetch" href="/vuepress/assets/js/69.83923766.js"><link rel="prefetch" href="/vuepress/assets/js/7.b60f99e7.js"><link rel="prefetch" href="/vuepress/assets/js/70.39d4195c.js"><link rel="prefetch" href="/vuepress/assets/js/71.e28be685.js"><link rel="prefetch" href="/vuepress/assets/js/72.e068c5cc.js"><link rel="prefetch" href="/vuepress/assets/js/73.3c5972cf.js"><link rel="prefetch" href="/vuepress/assets/js/74.2c300814.js"><link rel="prefetch" href="/vuepress/assets/js/75.16887871.js"><link rel="prefetch" href="/vuepress/assets/js/76.aef8e41e.js"><link rel="prefetch" href="/vuepress/assets/js/77.11355457.js"><link rel="prefetch" href="/vuepress/assets/js/78.d6a93a91.js"><link rel="prefetch" href="/vuepress/assets/js/79.394993f0.js"><link rel="prefetch" href="/vuepress/assets/js/8.affe4fa6.js"><link rel="prefetch" href="/vuepress/assets/js/80.60f3a775.js"><link rel="prefetch" href="/vuepress/assets/js/81.25fbce38.js"><link rel="prefetch" href="/vuepress/assets/js/82.beae6628.js"><link rel="prefetch" href="/vuepress/assets/js/83.3bd6257a.js"><link rel="prefetch" href="/vuepress/assets/js/84.851ad369.js"><link rel="prefetch" href="/vuepress/assets/js/85.8ddf405f.js"><link rel="prefetch" href="/vuepress/assets/js/86.8fcd8b07.js"><link rel="prefetch" href="/vuepress/assets/js/87.5d4b02bf.js"><link rel="prefetch" href="/vuepress/assets/js/88.e523ea38.js"><link rel="prefetch" href="/vuepress/assets/js/89.89ebef39.js"><link rel="prefetch" href="/vuepress/assets/js/9.a4881f71.js">
    <link rel="stylesheet" href="/vuepress/assets/css/0.styles.189cad16.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress/" class="home-link router-link-active"><img src="/vuepress/img/home.jpeg" alt="前端小蜗" class="logo"> <span class="site-name can-hide">前端小蜗</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="https://f2e.tech/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端学习路径
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://roadmap.sh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  学习路线图
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.cn/user/61995432544503" target="_blank" rel="noopener noreferrer" class="nav-link external">
  我的其他文章
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="https://f2e.tech/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端学习路径
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://roadmap.sh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  学习路线图
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.cn/user/61995432544503" target="_blank" rel="noopener noreferrer" class="nav-link external">
  我的其他文章
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vuepress/guide/" class="sidebar-link">介绍</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/JS基础/" class="sidebar-heading clickable open"><span>JS基础</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/%E4%BA%8B%E4%BB%B6%E5%A7%94%E6%89%98/" class="sidebar-link">JS事件</a></li><li><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/%E8%AF%8D%E6%B3%95%E7%8E%AF%E5%A2%83%E5%92%8C%E9%97%AD%E5%8C%85/" class="sidebar-link">词法环境和闭包</a></li><li><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/%E5%8E%9F%E5%9E%8B%E5%92%8C%E5%8E%9F%E5%9E%8B%E9%93%BE/" class="sidebar-link">原型和原型链</a></li><li><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/" aria-current="page" class="active sidebar-link">事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#_1-异步编程的意义" class="sidebar-link">1. 异步编程的意义</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#什么是异步编程-解决了什么问题" class="sidebar-link">什么是异步编程，解决了什么问题</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#📖浏览器和-node-js-中的异步应用场景" class="sidebar-link">📖浏览器和 Node.js 中的异步应用场景</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#_2-事件循环机制简介" class="sidebar-link">2. 事件循环机制简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#💡事件循环的概念和原理" class="sidebar-link">💡事件循环的概念和原理</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#🚀事件循环解决的核心问题" class="sidebar-link">🚀事件循环解决的核心问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#_3-javascript-中的事件循环" class="sidebar-link">3. JavaScript 中的事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#💻浏览器环境下的事件循环-event-loop" class="sidebar-link">💻浏览器环境下的事件循环(Event Loop)</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#🖥️node-js-环境下的事件循环" class="sidebar-link">🖥️Node.js 环境下的事件循环</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#🔍两者的区别和联系" class="sidebar-link">🔍两者的区别和联系</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#_4-🧰事件循环的作用" class="sidebar-link">4. 🧰事件循环的作用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#🔑启用异步编程" class="sidebar-link">🔑启用异步编程</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#🔗调度任务执行" class="sidebar-link">🔗调度任务执行</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#🔧优化性能" class="sidebar-link">🔧优化性能</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#🧯避免长时间阻塞" class="sidebar-link">🧯避免长时间阻塞</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#_5-👓常见的异步编程方法" class="sidebar-link">5. 👓常见的异步编程方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#回调函数" class="sidebar-link">回调函数</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#promise" class="sidebar-link">Promise</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#async-await" class="sidebar-link">async/await</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#事件和监听器" class="sidebar-link">事件和监听器</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#_6-实现一个简单的事件循环" class="sidebar-link">6. 实现一个简单的事件循环</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#_7-总结" class="sidebar-link">7. 总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#🔔异步编程模式的意义" class="sidebar-link">🔔异步编程模式的意义</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#💾事件循环的工作机制" class="sidebar-link">💾事件循环的工作机制</a></li><li class="sidebar-sub-header"><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/JavaScript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%AF%A6%E8%A7%A3/#💻在-javascript-中高效利用事件循环" class="sidebar-link">💻在 JavaScript 中高效利用事件循环</a></li></ul></li></ul></li><li><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/Promise/" class="sidebar-link">Promise 实现</a></li><li><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/Proxy/" class="sidebar-link">Proxy 与 Reflect</a></li><li><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/%E6%B7%B1%E5%85%A5%E6%A8%A1%E5%9D%97import%E5%92%8Crequire/" class="sidebar-link">深入模块Import 和 CommonJS</a></li><li><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/Mixin%E6%A8%A1%E5%BC%8F/" class="sidebar-link">Mixin 模式深度理解</a></li><li><a href="/vuepress/JS%E5%9F%BA%E7%A1%80/%E5%B0%BE%E9%80%92%E5%BD%92/" class="sidebar-link">递归,尾递归,执行上下文和堆栈</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/小程序/" class="sidebar-heading clickable"><span>小程序</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/浏览器/" class="sidebar-heading clickable"><span>浏览器</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/HTTP/" class="sidebar-heading clickable"><span>HTTP</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/Node/拦截器/" class="sidebar-heading clickable"><span>Node</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/Vue/vue" class="sidebar-heading clickable"><span>Vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/React/" class="sidebar-heading clickable"><span>React</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/算法/常见算法/" class="sidebar-heading clickable"><span>算法</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/工程体系/" class="sidebar-heading clickable"><span>前端工程化</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/最佳实践/" class="sidebar-heading clickable"><span>最佳实践</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/TS指南/" class="sidebar-heading clickable"><span>TypeScrpit</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/心得/" class="sidebar-heading clickable"><span>心得体会</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="javascript-异步编程和事件循环详解"><a href="#javascript-异步编程和事件循环详解" class="header-anchor">#</a> JavaScript 异步编程和事件循环详解</h1> <p>⏲️建议阅读时间: 15min</p> <h2 id="_1-异步编程的意义"><a href="#_1-异步编程的意义" class="header-anchor">#</a> 1. 异步编程的意义</h2> <p><img src="https://pub-a953275fa2c34c18b80fc1f84e3ea746.r2.dev/xiaowo/2023/08/b3c6ccaae0c1c149bd4ccd2f99914269.gif" alt=""></p> <h3 id="什么是异步编程-解决了什么问题"><a href="#什么是异步编程-解决了什么问题" class="header-anchor">#</a> 什么是异步编程，解决了什么问题</h3> <p><strong>异步编程是什么呢</strong>?</p> <p>简单说，异步编程就是不需要等待一个任务执行完毕，就可以继续执行其他任务的编程方式。</p> <p>🌰举个生活中的例子，平时我们做饭需要按顺序一步一步来，必须等一样做完才能做下一样。但是如果让好几个人一起做饭，他们就可以异步进行，同时做多件事，效率更高。（但是也不是所有的任务都可以异步，比如生孩子）</p> <p>编程也是一样，默认是同步执行，只有前一个任务做完，才能执行后一个任务。异步编程允许我们在等待一个任务完成的同时，继续执行其他任务。</p> <p><strong>异步编程解决了什么问题呢</strong>?</p> <p>主要解决了程序中一些不必要的等待时间问题。比如程序中有某些任务需要等待网络请求，文件读取，用户输入等情况。这种需要等待的时间对程序来说是“空转”时间。</p> <h3 id="📖浏览器和-node-js-中的异步应用场景"><a href="#📖浏览器和-node-js-中的异步应用场景" class="header-anchor">#</a> 📖浏览器和 Node.js 中的异步应用场景</h3> <p><img src="https://pub-a953275fa2c34c18b80fc1f84e3ea746.r2.dev/xiaowo/2023/08/08380c8ae803582528b2eacd05c4553d.png" alt=""></p> <p>在浏览器和 Node.js 中，异步编程很常见，主要应用在以下场景:</p> <ul><li>网络请求。比如 Ajax 请求，需要等待服务器响应，可以异步执行。</li> <li>文件操作。读取文件、访问数据库等 IO 操作，都可能需要等待，可以异步处理。</li> <li>用户输入。比如点击、输入等用户交互，不能假设用户的响应时间，需要异步处理。</li> <li>定时任务。设置定时器执行某任务，也是典型的异步操作。</li></ul> <p>通过异步编程，这些需要等待的任务不会造成整个程序的阻塞，可以优化程序执行流程，提高用户体验。</p> <p>所以异步编程对于今天的网络应用和交互程序来说，是非常重要的编程方式。正确使用异步编程可以让你的程序更高效、更流畅。</p> <h2 id="_2-事件循环机制简介"><a href="#_2-事件循环机制简介" class="header-anchor">#</a> 2. 事件循环机制简介</h2> <h3 id="💡事件循环的概念和原理"><a href="#💡事件循环的概念和原理" class="header-anchor">#</a> 💡事件循环的概念和原理</h3> <p><strong>什么是事件循环呢</strong>?</p> <p>事件循环是一种编程模式。它的核心思想是维护一个事件队列，循环检查队列，处理队列中的事件。</p> <p>我们比较一下同步模型和事件循环模型:</p> <ul><li>同步模型:程序按顺序依次执行任务，必须等待前一个任务结束才能执行下一个任务。</li> <li>事件循环模型:程序维护一个待处理事件队列，循环检查队列，找出需要处理的事件并触发回调函数，然后再循环检查队列......这样一个无结束的循环。</li></ul> <p>事件循环允许我们注册事件和对应的回调函数，然后程序会自动按照发生顺序调用这些回调函数。</p> <p>举个例子，假设我们注册了点击和滚动事件的监听器函数，然后点击并滚动页面，事件循环内部会自动调用注册的回调函数处理点击和滚动事件。</p> <p>通过这样的机制，我们就可以采用异步编程方式来响应事件，不需要像同步模型那样等待事件处理完再做其他事情。</p> <h3 id="🚀事件循环解决的核心问题"><a href="#🚀事件循环解决的核心问题" class="header-anchor">#</a> 🚀事件循环解决的核心问题</h3> <ul><li>可以异步处理并发事件，不需要阻塞程序等待。</li> <li>可以 registers 多个事件和回调函数，事件循环会自动调用它们。</li> <li>不同事件可以共享同一个线程，不需要为每个事件创建新线程。</li> <li>可以将事件队列作为线程间通信的消息通道。</li></ul> <h2 id="_3-javascript-中的事件循环"><a href="#_3-javascript-中的事件循环" class="header-anchor">#</a> 3. JavaScript 中的事件循环</h2> <h3 id="💻浏览器环境下的事件循环-event-loop"><a href="#💻浏览器环境下的事件循环-event-loop" class="header-anchor">#</a> 💻浏览器环境下的事件循环(Event Loop)</h3> <p><img src="https://pub-a953275fa2c34c18b80fc1f84e3ea746.r2.dev/xiaowo/2023/08/8761c34242a9019153a56a6562deb271.jpeg" alt=""></p> <p>在浏览器环境下，JavaScript 语言实现了一个 Event Loop 来处理事件循环。</p> <p>它的工作流程是这样的:</p> <ol><li>所有同步任务直接在主线程上执行，形成一个执行栈。</li> <li>主线程之外，还存在一个&quot;任务队列&quot;(task queue)。只要异步任务有了运行结果，就在&quot;任务队列&quot;之中放置一个事件。</li> <li>一旦&quot;执行栈&quot;中的所有同步任务执行完毕，系统就会读取&quot;任务队列&quot;，看看里面有哪些事件。那些对应的异步任务，于是结束等待状态，进入执行栈，开始执行。</li> <li>主线程不断重复上面的第三步。</li></ol> <p>所以浏览器的事件循环是通过任务队列来实现的。异步任务被抛到队列中，等待同步任务结束，然后从队列中读取事件并执行。</p> <h3 id="🖥️node-js-环境下的事件循环"><a href="#🖥️node-js-环境下的事件循环" class="header-anchor">#</a> 🖥️Node.js 环境下的事件循环</h3> <p><img src="https://pub-a953275fa2c34c18b80fc1f84e3ea746.r2.dev/xiaowo/2023/08/b7dde19d26bd5b26b13d978cbaa5ce33.jpeg" alt=""></p> <p>而在 Node.js 中，它实现了一个 Event Loop 来处理事件，与浏览器略有不同:</p> <ol><li>Node 的 Event Loop 只包含 6 个阶段，它们会控制事件的执行。</li> <li>每个阶段都有一个先进先出的回调队列，只有回调队列清空后才会进入下一阶段。</li> <li>通过这种阶段控制机制，Node 实现了非阻塞 I/O 模型。</li></ol> <h3 id="🔍两者的区别和联系"><a href="#🔍两者的区别和联系" class="header-anchor">#</a> 🔍两者的区别和联系</h3> <p>区别:</p> <ol><li>浏览器的事件循环是单一的，而 Node.js 有多个阶段的事件循环。</li> <li>浏览器将异步任务统一放入任务队列，Node.js 每个阶段有独立的回调队列。</li> <li>浏览器没有阶段的概念，所有任务都在一个队列里，Node.js 通过不同阶段来控制任务执行。</li> <li>浏览器的事件循环是由 HTML5 标准定义，Node.js 的事件循环规范是独立的。</li></ol> <p>联系:</p> <ol><li>它们底层都实现了事件循环机制，可以处理异步任务而不阻塞主线程。</li> <li>都维护一个队列来存储待处理事件，然后循环查找新的事件。</li> <li>都会在主线程空闲时，从队列中取出事件处理回调函数执行。</li> <li>都允许非阻塞 IO 和事件驱动的编程方式。</li> <li>都需要避免长时间运行的任务 blocking 主线程。</li> <li>它们帮助 JavaScript 实现了异步非阻塞的并发模型。</li></ol> <h2 id="_4-🧰事件循环的作用"><a href="#_4-🧰事件循环的作用" class="header-anchor">#</a> 4. 🧰事件循环的作用</h2> <h3 id="🔑启用异步编程"><a href="#🔑启用异步编程" class="header-anchor">#</a> 🔑启用异步编程</h3> <p>事件循环的第一个作用是启用异步编程。</p> <p>通过事件循环，我们可以把一些需要等待结果的任务注册为异步任务，不会阻塞主线程，非常适合处理诸如网络请求、文件 I/O 等异步操作。</p> <p>举个例子，在浏览器中发一个 Ajax 请求。我们注册一个回调函数来接收响应，然后该请求被加入事件循环的&quot;任务队列&quot;。我们的主线程可以接着做其他工作，当这个 Ajax 响应返回的时候，对应的回调函数会在事件循环中被调用。这样就实现了异步编程方式。</p> <h3 id="🔗调度任务执行"><a href="#🔗调度任务执行" class="header-anchor">#</a> 🔗调度任务执行</h3> <p>事件循环的第二个作用是调度任务执行。</p> <p>事件循环会按照正确的顺序执行回调函数，比如先点击按钮，后滚动页面，事件循环会保证先调用点击的回调函数，然后再调用滚动的回调。这样就实现了调度作用。</p> <h3 id="🔧优化性能"><a href="#🔧优化性能" class="header-anchor">#</a> 🔧优化性能</h3> <p>事件循环的第三个作用是优化性能。</p> <p>通过异步非阻塞的方式执行任务，可以大大减少程序中的等待时间，充分利用 CPU，也节约了线程资源，非常高效。</p> <h3 id="🧯避免长时间阻塞"><a href="#🧯避免长时间阻塞" class="header-anchor">#</a> 🧯避免长时间阻塞</h3> <p>最后，事件循环避免了长时间运行的任务 blocking 主线程。</p> <p>因为事件循环会按照队列顺序执行回调函数，所以每个回调函数不能运行太长时间，否则会堵塞后面的任务。通过这种方式，事件循环很好的避免了单个任务的长时间阻塞。</p> <h2 id="_5-👓常见的异步编程方法"><a href="#_5-👓常见的异步编程方法" class="header-anchor">#</a> 5. 👓常见的异步编程方法</h2> <h3 id="回调函数"><a href="#回调函数" class="header-anchor">#</a> 回调函数</h3> <p>第一种是回调函数。一个函数可以接受另一个函数作为参数，这个作为参数传递进去的函数就叫回调函数。回调函数通常在当前任务完成后被执行。</p> <p>例如，我们可以注册一个回调函数来处理 Ajax 返回的结果:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">ajaxCallback</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">&quot;http://example.com&quot;</span>， ajaxCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h3> <p>Promise 是一个对象，代表了一个异步任务的最终完成或失败。我们可以在 Promise 对象上注册回调函数。</p> <p>使用 Promise 的话，代码如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="async-await"><a href="#async-await" class="header-anchor">#</a> async/await</h3> <p>async/await，这是基于 Promise 实现的语法糖。async 函数会返回一个 Promise 对象，await 等待 Promise 结果:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">myFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="事件和监听器"><a href="#事件和监听器" class="header-anchor">#</a> 事件和监听器</h3> <p>最后是事件和监听器，这是浏览器异步编程的主要方式。例如可以为按钮添加点击事件:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;myBtn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span>， <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 收到点击事件后的处理</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_6-实现一个简单的事件循环"><a href="#_6-实现一个简单的事件循环" class="header-anchor">#</a> 6. 实现一个简单的事件循环</h2> <p>往往事件循环代表了应用的整个生命周期，事件循环结束意味着应用也就退出了。</p> <p>我们先来看一个简陋版的事件循环系统。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">EventSystem</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 任务队列</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 追加任务</span>
  <span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 事件循环</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> func <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 新建一个事件循环系统</span>
<span class="token keyword">const</span> eventSystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 生产任务</span>
eventSystem<span class="token punctuation">.</span><span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 启动事件循环</span>
eventSystem<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 生产任务</span>
eventSystem<span class="token punctuation">.</span><span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>根据上面我们了解到的知识，我们可以知道这个简陋版的事件循环逻辑如下</p> <ol><li>新建一个事件循环系统；</li> <li>生产任务；</li> <li>启动事件循环系统处理任务。</li></ol> <p>但是！如果你运行就会发现，当没有任务时，它就会陷入死循环，这不仅浪费了 CPU，新的任务也无法继续添加了。</p> <p>因此，在一个事件循环系统中，如何处理没有任务时的情况非常关键。这应该怎么解决呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">EventSystem</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 需要处理的任务队列</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 标记是否需要退出事件循环</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 有任务时调用该函数&quot;唤醒&quot; await</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wakeup <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 没有任务时，事件循环的进入&quot;阻塞&quot;状态</span>
  <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 记录 resolve，可能在睡眠期间有任务到来，则需要提前唤醒</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">wakeup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>wakeup <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 停止事件循环，如果正在&quot;阻塞&quot;，则&quot;唤醒它&quot;</span>
  <span class="token function">setStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stop <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wakeup <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 生产任务</span>
  <span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wakeup <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 处理任务队列</span>
  <span class="token function">handleTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 本轮事件循环的回调中加入的任务，下一轮事件循环再处理，防止其他任务没有机会处理</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> func <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 事件循环的实现</span>
  <span class="token keyword">async</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 stop 等于 1 则退出事件循环</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stop <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 处理任务，可能没有任务需要处理</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 处理任务过程中如果设置了 stop 标记则退出事件循环</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stop <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 没有任务了，进入睡眠</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 退出前可能还有任务没处理，处理完再退出</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 新建一个事件循环系统</span>
<span class="token keyword">const</span> eventSystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 启动前生成的任务</span>
eventSystem<span class="token punctuation">.</span><span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 模拟定时生成一个任务</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  eventSystem<span class="token punctuation">.</span><span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eventSystem<span class="token punctuation">.</span><span class="token function">setStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>， <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 启动事件循环</span>
eventSystem<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 启动后生成的任务</span>
eventSystem<span class="token punctuation">.</span><span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>现在我们就有了一个简单但是核心功能都有的事件循环系统。</p> <ol><li>事件循环的整体架构是一个 while 循环。</li> <li>定义任务类型和队列，这里只有一种任务类型和一个队列，比如 Node.js 里有好几种，每种类型的任务有不同的作用。</li> <li>没有任务的时候怎么处理：进入阻塞状态，而不是靠忙轮询。</li></ol> <p>第 3 点是事件循环系统中非常重要的逻辑，任务队列中不可能一直都有任务需要处理，这就意味着生产任务可以是一个异步的过程，所以事件循环系统就需要有一种等待 / 唤醒机制。</p> <h2 id="_7-总结"><a href="#_7-总结" class="header-anchor">#</a> 7. 总结</h2> <h3 id="🔔异步编程模式的意义"><a href="#🔔异步编程模式的意义" class="header-anchor">#</a> 🔔异步编程模式的意义</h3> <p>异步编程模式非常重要，它允许我们在等待某个操作时继续执行其他代码，大大提高了效率。</p> <p>其核心是事件循环机制。它维护一个事件队列，然后循环检查队列并执行回调函数，这样就实现了异步执行流程。</p> <p>JavaScript 语言利用事件循环实现了异步编程。比如，在浏览器中我们可以注册事件回调函数，Node.js 也使用事件循环处理非阻塞 IO。</p> <h3 id="💾事件循环的工作机制"><a href="#💾事件循环的工作机制" class="header-anchor">#</a> 💾事件循环的工作机制</h3> <ol><li>事件循环的整体架构是一个 while 循环。</li> <li>定义任务类型和队列，这里只有一种任务类型和一个队列，比如 Node.js 里有好几种，每种类型的任务有不同的作用。</li> <li>没有任务的时候怎么处理：进入阻塞状态，而不是靠忙轮询。</li></ol> <h3 id="💻在-javascript-中高效利用事件循环"><a href="#💻在-javascript-中高效利用事件循环" class="header-anchor">#</a> 💻在 JavaScript 中高效利用事件循环</h3> <p>要在 JavaScript 中高效利用事件循环，我们可以:</p> <ol><li>多用异步 API，比如定时器、Promise 等，避免阻塞。</li> <li>合理使用异步语法 async/await 来组织代码。</li> <li>避免长时间运行的任务阻塞线程。</li> <li>使用 Promise 链或 async/await 处理回调地狱。</li> <li>合理使用定时器和请求拆分来控制并发。</li> <li>使用事件循环可视化工具观察事件循环状态。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/vuepress/assets/js/app.40312837.js" defer></script><script src="/vuepress/assets/js/2.cf1e524c.js" defer></script><script src="/vuepress/assets/js/13.110f8559.js" defer></script>
  </body>
</html>
