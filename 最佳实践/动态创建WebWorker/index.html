<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebWorker | 前端小蜗</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/vuepress/img/home.jpeg">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/vuepress/assets/css/0.styles.189cad16.css" as="style"><link rel="preload" href="/vuepress/assets/js/app.40312837.js" as="script"><link rel="preload" href="/vuepress/assets/js/2.cf1e524c.js" as="script"><link rel="preload" href="/vuepress/assets/js/67.93aa23db.js" as="script"><link rel="prefetch" href="/vuepress/assets/js/10.a610a9ba.js"><link rel="prefetch" href="/vuepress/assets/js/11.f87d06bd.js"><link rel="prefetch" href="/vuepress/assets/js/12.11a58652.js"><link rel="prefetch" href="/vuepress/assets/js/13.110f8559.js"><link rel="prefetch" href="/vuepress/assets/js/14.322c46a5.js"><link rel="prefetch" href="/vuepress/assets/js/15.b2b443b5.js"><link rel="prefetch" href="/vuepress/assets/js/16.7ff17cba.js"><link rel="prefetch" href="/vuepress/assets/js/17.fc193e79.js"><link rel="prefetch" href="/vuepress/assets/js/18.52d0a4c4.js"><link rel="prefetch" href="/vuepress/assets/js/19.25f2d672.js"><link rel="prefetch" href="/vuepress/assets/js/20.c6723148.js"><link rel="prefetch" href="/vuepress/assets/js/21.74e5c0f6.js"><link rel="prefetch" href="/vuepress/assets/js/22.e6d1a64a.js"><link rel="prefetch" href="/vuepress/assets/js/23.86aba3c2.js"><link rel="prefetch" href="/vuepress/assets/js/24.3ae19470.js"><link rel="prefetch" href="/vuepress/assets/js/25.edcf91c9.js"><link rel="prefetch" href="/vuepress/assets/js/26.89319ef2.js"><link rel="prefetch" href="/vuepress/assets/js/27.9e533376.js"><link rel="prefetch" href="/vuepress/assets/js/28.93a6ba41.js"><link rel="prefetch" href="/vuepress/assets/js/29.d72f0022.js"><link rel="prefetch" href="/vuepress/assets/js/3.a5adedeb.js"><link rel="prefetch" href="/vuepress/assets/js/30.871cc77c.js"><link rel="prefetch" href="/vuepress/assets/js/31.11915659.js"><link rel="prefetch" href="/vuepress/assets/js/32.2d371a40.js"><link rel="prefetch" href="/vuepress/assets/js/33.19d049e9.js"><link rel="prefetch" href="/vuepress/assets/js/34.52633d55.js"><link rel="prefetch" href="/vuepress/assets/js/35.c77625e0.js"><link rel="prefetch" href="/vuepress/assets/js/36.ec517178.js"><link rel="prefetch" href="/vuepress/assets/js/37.e955d687.js"><link rel="prefetch" href="/vuepress/assets/js/38.a76e9c38.js"><link rel="prefetch" href="/vuepress/assets/js/39.0758c6eb.js"><link rel="prefetch" href="/vuepress/assets/js/4.7fc56b7b.js"><link rel="prefetch" href="/vuepress/assets/js/40.bfc21b26.js"><link rel="prefetch" href="/vuepress/assets/js/41.1cca45c8.js"><link rel="prefetch" href="/vuepress/assets/js/42.76b92fb2.js"><link rel="prefetch" href="/vuepress/assets/js/43.5bcb4c47.js"><link rel="prefetch" href="/vuepress/assets/js/44.0bf86704.js"><link rel="prefetch" href="/vuepress/assets/js/45.b6f1d2ae.js"><link rel="prefetch" href="/vuepress/assets/js/46.d942ba15.js"><link rel="prefetch" href="/vuepress/assets/js/47.8bb95ad0.js"><link rel="prefetch" href="/vuepress/assets/js/48.fb8ad7c2.js"><link rel="prefetch" href="/vuepress/assets/js/49.fb46b14b.js"><link rel="prefetch" href="/vuepress/assets/js/5.6ac62750.js"><link rel="prefetch" href="/vuepress/assets/js/50.49f08253.js"><link rel="prefetch" href="/vuepress/assets/js/51.7663b0cd.js"><link rel="prefetch" href="/vuepress/assets/js/52.90d8fc5a.js"><link rel="prefetch" href="/vuepress/assets/js/53.00bdcc76.js"><link rel="prefetch" href="/vuepress/assets/js/54.93e18111.js"><link rel="prefetch" href="/vuepress/assets/js/55.c887fc69.js"><link rel="prefetch" href="/vuepress/assets/js/56.0f6408ae.js"><link rel="prefetch" href="/vuepress/assets/js/57.e8334a13.js"><link rel="prefetch" href="/vuepress/assets/js/58.52393270.js"><link rel="prefetch" href="/vuepress/assets/js/59.d0661709.js"><link rel="prefetch" href="/vuepress/assets/js/6.d831054f.js"><link rel="prefetch" href="/vuepress/assets/js/60.0b34950f.js"><link rel="prefetch" href="/vuepress/assets/js/61.13e9f684.js"><link rel="prefetch" href="/vuepress/assets/js/62.caee8c5c.js"><link rel="prefetch" href="/vuepress/assets/js/63.a22fbd8d.js"><link rel="prefetch" href="/vuepress/assets/js/64.d8204a06.js"><link rel="prefetch" href="/vuepress/assets/js/65.4d094f10.js"><link rel="prefetch" href="/vuepress/assets/js/66.b4582d16.js"><link rel="prefetch" href="/vuepress/assets/js/68.b57ddd04.js"><link rel="prefetch" href="/vuepress/assets/js/69.83923766.js"><link rel="prefetch" href="/vuepress/assets/js/7.b60f99e7.js"><link rel="prefetch" href="/vuepress/assets/js/70.39d4195c.js"><link rel="prefetch" href="/vuepress/assets/js/71.e28be685.js"><link rel="prefetch" href="/vuepress/assets/js/72.e068c5cc.js"><link rel="prefetch" href="/vuepress/assets/js/73.3c5972cf.js"><link rel="prefetch" href="/vuepress/assets/js/74.2c300814.js"><link rel="prefetch" href="/vuepress/assets/js/75.16887871.js"><link rel="prefetch" href="/vuepress/assets/js/76.aef8e41e.js"><link rel="prefetch" href="/vuepress/assets/js/77.11355457.js"><link rel="prefetch" href="/vuepress/assets/js/78.d6a93a91.js"><link rel="prefetch" href="/vuepress/assets/js/79.394993f0.js"><link rel="prefetch" href="/vuepress/assets/js/8.affe4fa6.js"><link rel="prefetch" href="/vuepress/assets/js/80.60f3a775.js"><link rel="prefetch" href="/vuepress/assets/js/81.25fbce38.js"><link rel="prefetch" href="/vuepress/assets/js/82.beae6628.js"><link rel="prefetch" href="/vuepress/assets/js/83.3bd6257a.js"><link rel="prefetch" href="/vuepress/assets/js/84.851ad369.js"><link rel="prefetch" href="/vuepress/assets/js/85.8ddf405f.js"><link rel="prefetch" href="/vuepress/assets/js/86.8fcd8b07.js"><link rel="prefetch" href="/vuepress/assets/js/87.5d4b02bf.js"><link rel="prefetch" href="/vuepress/assets/js/88.e523ea38.js"><link rel="prefetch" href="/vuepress/assets/js/89.89ebef39.js"><link rel="prefetch" href="/vuepress/assets/js/9.a4881f71.js">
    <link rel="stylesheet" href="/vuepress/assets/css/0.styles.189cad16.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress/" class="home-link router-link-active"><img src="/vuepress/img/home.jpeg" alt="前端小蜗" class="logo"> <span class="site-name can-hide">前端小蜗</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="https://f2e.tech/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端学习路径
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://roadmap.sh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  学习路线图
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.cn/user/61995432544503" target="_blank" rel="noopener noreferrer" class="nav-link external">
  我的其他文章
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="https://f2e.tech/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端学习路径
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://roadmap.sh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  学习路线图
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.cn/user/61995432544503" target="_blank" rel="noopener noreferrer" class="nav-link external">
  我的其他文章
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vuepress/guide/" class="sidebar-link">介绍</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/JS基础/" class="sidebar-heading clickable"><span>JS基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/小程序/" class="sidebar-heading clickable"><span>小程序</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/浏览器/" class="sidebar-heading clickable"><span>浏览器</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/HTTP/" class="sidebar-heading clickable"><span>HTTP</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/Node/拦截器/" class="sidebar-heading clickable"><span>Node</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/Vue/vue" class="sidebar-heading clickable"><span>Vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/React/" class="sidebar-heading clickable"><span>React</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/算法/常见算法/" class="sidebar-heading clickable"><span>算法</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/工程体系/" class="sidebar-heading clickable"><span>前端工程化</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/最佳实践/" class="sidebar-heading clickable open"><span>最佳实践</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="sidebar-link">性能优化</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8/" class="sidebar-link">前端安全问题</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" class="sidebar-link">函数式编程</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E9%98%B2%E6%8A%96%E8%8A%82%E6%B5%81/" class="sidebar-link">防抖和节流的原理和实现</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/Feed%E6%B5%81(%E4%BA%A4%E4%BA%92%E5%BC%8F%E6%8E%A8%E8%8D%90)%E6%8E%A2%E7%B4%A2%E5%BA%94%E7%94%A8/" class="sidebar-link">Feed流(交互式推荐)探索应用</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%B0%86%E8%BD%AE%E8%AF%A2%E6%94%BE%E5%85%A5webworker%E4%B8%AD/" class="sidebar-link">前端性能优化：使用 Web Workers 实现轮询</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/webpack%E7%9F%A5%E8%AF%86%E7%82%B9/" class="sidebar-link">webpack知识点</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/" class="sidebar-link">垃圾回收机制</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="sidebar-link">常用设计模式</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/" class="sidebar-link">断点续传</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E6%8B%96%E6%94%BE/" class="sidebar-link">拖放</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E7%8A%B6%E6%80%81%E6%9C%BA/" class="sidebar-link">状态机 （finite-state-machines）</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E9%A2%84%E8%AF%B7%E6%B1%82%E7%AD%96%E7%95%A5/" class="sidebar-link">预请求策略</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E6%89%8B%E6%9C%BA%E5%BC%80%E5%90%AF%E6%91%84%E5%83%8F%E5%A4%B4%E8%AF%86%E5%88%AB%E5%90%8E%E5%81%9A%E5%87%BA%E8%A1%8C%E4%B8%BA/" class="sidebar-link">网页调用摄像头识别物体后做成行为</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/" aria-current="page" class="active sidebar-link">WebWorker 和动态创建webworker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#web-worker-的工作原理" class="sidebar-link">Web Worker 的工作原理</a></li><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#web-worker-的适用场景" class="sidebar-link">Web Worker 的适用场景</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#以下是一些-web-worker-的适用场景" class="sidebar-link">以下是一些 Web Worker 的适用场景：</a></li><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#但并不是所有的场景都适合使用-web-worker-如" class="sidebar-link">但并不是所有的场景都适合使用 Web Worker，如：</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#兼容性和限制" class="sidebar-link">兼容性和限制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#兼容性" class="sidebar-link">兼容性：</a></li><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#限制" class="sidebar-link">限制：</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#web-worker-的使用" class="sidebar-link">Web Worker 的使用</a></li><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#动态-worker-的简单封装" class="sidebar-link">动态 Worker 的简单封装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#调用区分优化" class="sidebar-link">调用区分优化</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#对比使用-web-worker-和不使用-web-worker-的性能" class="sidebar-link">对比使用 Web Worker 和不使用 Web Worker 的性能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#不使用-web-worker" class="sidebar-link">不使用 Web Worker</a></li><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#使用-web-worker" class="sidebar-link">使用 Web Worker</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAWebWorker/#参考链接" class="sidebar-link">参考链接</a></li></ul></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E7%BA%AFCSS%E5%AE%9E%E7%8E%B0%E6%96%87%E5%AD%97%E7%8E%AF%E7%BB%95/" class="sidebar-link">纯 CSS 实现文字换行环绕效果</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%AE%9E%E8%B7%B5-vue3%E9%A1%B9%E7%9B%AE%E9%99%8D%E7%BA%A7vue2/" class="sidebar-link">把 vue3 项目降级到 vue2 ⬇️</a></li><li><a href="/vuepress/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/js%E7%94%9F%E6%88%90%E6%96%87%E4%BB%B6/" class="sidebar-link">通过原生 JS 完成 html 文件的生成</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/TS指南/" class="sidebar-heading clickable"><span>TypeScrpit</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress/心得/" class="sidebar-heading clickable"><span>心得体会</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webworker"><a href="#webworker" class="header-anchor">#</a> WebWorker</h1> <blockquote><p>本文前半部分关于 Web Worker 的简介，原理，适用场景和兼容性。</p> <p>关于动态创建 Web Worker 可直接跳转到 【动态 Worker 的简单封装】</p></blockquote> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>Web Worker 是浏览器提供的一种 JavaScript API，用于在后台线程中执行耗时的任务，以避免阻塞主线程。它可以提高网页的响应性能和用户体验。</p> <p>当网页执行耗时的任务时，例如进行复杂的计算或处理大量数据，如果这些任务在主线程中执行，会导致主线程被占用，页面可能会出现卡顿、无响应的情况。使用 Web Worker 可以将这些耗时的任务放在后台线程中进行，不会影响主线程的运行，页面仍然可以保持流畅的交互。</p> <p>Web Worker 的作用不仅限于提高网页的响应性能，它还可以改善用户体验。通过将耗时的任务放在后台线程中执行，用户在与页面进行交互时不会感到卡顿，页面的响应速度更快，给用户带来更好的体验。</p> <p>Web Worker 是一种强大的工具，可以帮助开发者优化网页性能，提高用户体验。在下一部分，我们将更详细地探讨使用 Web Worker 的好处。</p> <h2 id="web-worker-的工作原理"><a href="#web-worker-的工作原理" class="header-anchor">#</a> Web Worker 的工作原理</h2> <p><img src="https://pub-a953275fa2c34c18b80fc1f84e3ea746.r2.dev/xiaowo/2023/08/b1a7eafc278cda5ff8bb395867d33866.png" alt=""></p> <p>当使用 Web Worker 时，开发者可以创建一个独立的后台线程，该线程可以执行一些复杂的计算、处理大量数据或执行其他耗时的操作。主线程可以继续执行其他任务，而不会受到后台线程的影响。
Web Worker 的工作原理如下：</p> <ol><li>开发者创建一个新的 Web Worker 对象，并指定要执行的脚本文件。</li> <li>浏览器会为该 Web Worker 创建一个独立的后台线程，该线程会加载并执行指定的脚本文件。</li> <li>在后台线程中，开发者可以通过监听事件来接收和发送消息。例如，可以通过 postMessage 方法向后台线程发送消息，后台线程可以通过 onmessage 事件监听来接收消息。</li> <li>后台线程执行完任务后，可以通过 postMessage 方法向主线程发送消息，主线程可以通过 onmessage 事件监听来接收消息。</li> <li>主线程和后台线程之间的通信是通过消息传递机制实现的，这样可以确保线程之间的安全性和可靠性。</li></ol> <h2 id="web-worker-的适用场景"><a href="#web-worker-的适用场景" class="header-anchor">#</a> Web Worker 的适用场景</h2> <h3 id="以下是一些-web-worker-的适用场景"><a href="#以下是一些-web-worker-的适用场景" class="header-anchor">#</a> 以下是一些 Web Worker 的适用场景：</h3> <ol><li>计算密集型任务：如果你的应用需要执行大量的计算操作，例如图像处理、数据分析、物理模拟等，使用 Web Worker 可以将这些任务放在后台线程中执行，避免阻塞用户界面的响应性能。</li> <li>大规模数据处理：当你需要处理大量数据时，Web Worker 可以帮助你并行执行任务，提高处理速度。例如，在前端绘制图表时，你可以将数据处理和绘制分离到不同的线程中，以提高绘制性能。</li> <li>长时间运行的任务：某些任务可能需要较长的时间才能完成，例如文件上传、数据导入等。使用 Web Worker 可以将这些任务放在后台线程中执行，使用户可以同时进行其他操作，而不会感觉到应用程序的卡顿。</li> <li>多线程编程：Web Worker 提供了多线程编程的能力，可以将任务分解为多个子任务，并在多个线程中并行执行。这对于某些复杂的算法或任务来说非常有用，可以提高执行效率。</li></ol> <h3 id="但并不是所有的场景都适合使用-web-worker-如"><a href="#但并不是所有的场景都适合使用-web-worker-如" class="header-anchor">#</a> 但并不是所有的场景都适合使用 Web Worker，如：</h3> <ol><li>用户界面交互：如果你的应用需要频繁地更新用户界面或响应用户输入，使用 Web Worker 可能会导致延迟和不一致的用户体验。因为 Web Worker 在后台运行，无法直接访问用户界面元素。</li> <li>DOM 操作：Web Worker 不能直接访问或修改 DOM 元素。如果你的任务需要对页面上的 DOM 进行操作，那么 Web Worker 并不适合。</li> <li>安全限制：由于安全性考虑，Web Worker 有一些限制。例如，它们不能访问某些浏览器 API，如 localStorage 和 IndexedDB。如果你的任务需要访问这些 API，那么 Web Worker 可能不适合。</li> <li>简单任务：如果你的任务很简单且不需要大量计算资源，使用 Web Worker 可能会增加复杂性而不带来明显的性能提升。</li></ol> <h2 id="兼容性和限制"><a href="#兼容性和限制" class="header-anchor">#</a> 兼容性和限制</h2> <p><img src="https://pub-a953275fa2c34c18b80fc1f84e3ea746.r2.dev/xiaowo/2023/08/223aaee5d473dc4d757beb13824f0227.png" alt=""></p> <h3 id="兼容性"><a href="#兼容性" class="header-anchor">#</a> 兼容性：</h3> <ul><li>Web Worker 在现代浏览器中得到广泛支持，包括 Chrome、Firefox、Safari 和 Edge 等主流浏览器。</li> <li>但是，旧版的 Internet Explorer 不支持 Web Worker。</li></ul> <h3 id="限制"><a href="#限制" class="header-anchor">#</a> 限制：</h3> <ul><li>Web Worker 无法直接访问 DOM 元素，因此不能执行与 DOM 相关的操作，如修改页面内容或操作表单等。</li> <li>Web Worker 不能访问一些浏览器 API，如 localStorage 和 IndexedDB。这是出于安全性考虑，以防止恶意代码访问用户的敏感数据。</li> <li>由于 Web Worker 在后台运行，它们无法直接与主线程进行通信。必须使用消息传递机制来在主线程和 Web Worker 之间传递数据和命令。</li> <li>Web Worker 只能执行纯粹的 JavaScript 代码，不能执行与浏览器环境相关的操作，如打开新窗口或重定向页面等。</li></ul> <h2 id="web-worker-的使用"><a href="#web-worker-的使用" class="header-anchor">#</a> Web Worker 的使用</h2> <p>Worker() 构造函数创建一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Worker" target="_blank" rel="noopener noreferrer">Worker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 对象，该对象执行指定的 URL 脚本。这个脚本必须遵守 <strong>同源策略</strong> 。</p> <p><code>const myWorker = new Worker(aURL, options);</code></p> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Worker/Worker" target="_blank" rel="noopener noreferrer">MDN 参考链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://pub-a953275fa2c34c18b80fc1f84e3ea746.r2.dev/xiaowo/2023/08/cd5d0db5721d2192f9c2d547079a0f37.png" alt=""> <strong>注意： 我们可以看到脚本的 MIME 类型必须为 text/javascript。</strong></p> <p>所以我们可以利用 Blob 来动态创建 WebWorker，这样我们就可以在实际工程中更好的使用。我们希望 Web Worker 能解决如下几个问题：</p> <ul><li>可根据不同业务属性动态创建不同的 Web Worker；</li> <li>API 简单易用，例如通过 Promise 链式调用替换相对较为繁琐的事件监听处理逻辑；</li> <li>代码可复用，且最好不需对项目所依赖的构建工具进行更改；</li></ul> <h2 id="动态-worker-的简单封装"><a href="#动态-worker-的简单封装" class="header-anchor">#</a> 动态 Worker 的简单封装</h2> <p>下面我们先来写一个简单的 Web Worker 示例，假设我们在 Worker 收到数据时有一个简单的判断逻辑，即只处理 method='format' 的消息：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token constant">URL</span> <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span> <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitURL<span class="token punctuation">;</span>

<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">onmessage = ({ data: { data } }) =&gt; {
  console.log('Message received **from** main script');
  const {method} = data;
  if (data.data &amp;&amp; method === 'format') {
    postMessage({
      data: {
        'res': 'I am a customized result string.',
      }
    });
  }
  console.log('Posting message back to main script');
}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>response<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;application/javascript&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 事件处理</span>
worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Response: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&quot;format&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个 Demo 会建立一个 Web Worker 并向其发送一段文本，而 Worker 在处理完毕后主线程会把结果弹窗显示出来。接下来，我们就用它继续操作。</p> <p>一个动态 Worker 结构应该长成如下这样，包含构造函数、动态调用函数以及 Worker 销毁函数，而构造函数中至少应该定义好 Worker 用到的全局变量、数据处理函数以及 onmessage 事件处理函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">BASE_DATASETS</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">DynamicWorker</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">worker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 依赖的全局变量声明
     * 如果 BASE_DATASETS 非字符串形式，可调用 JSON.stringify 等方法进行处理
     * 保证变量的正常声明
     */</span>
    <span class="token keyword">const</span> <span class="token constant">CONSTS</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">const base = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">BASE_DATASETS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 数据处理函数
     */</span>
    <span class="token keyword">const</span> formatFn <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">const formatFn = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>worker<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 内部 onmessage 处理
     */</span>
    <span class="token keyword">const</span> onMessageHandlerFn <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">self.onmessage = ()=&gt;{}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 返回结果
     * @param {*} param0
     */</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleResult</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(()=&gt;{</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">CONSTS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>formatFn<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>onMessageHandlerFn<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">})()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;text/javascript&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>worker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> handleResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 动态调用
   */</span>
  <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上代码有几点需要解释下，比如生成 Blob 对象时，由于入参是字符串数组，如果只是调用 .toString()，便无法拿到函数名，因此所有字符串采用变量命名的形式定义。接着我们调用 URL.createObjectURL 生成对象 URL，在创建完 Worker 后调用 URL.revokeObjectURL() 让浏览器知道不再需要对这个文件保持引用。</p> <p>URL.revokeObjectURL() 静态方法用来释放一个之前通过调用 URL.createObjectURL() 创建的已经存在的 URL 对象。当你结束使用某个 URL 对象时，应该通过调用这个方法来让浏览器知道不再需要保持这个文件的引用了。详见 MDN API.</p> <p>内部接收与响应消息的函数应该做逻辑判断并发送对应信息返回主线程，我们这样完善 onMessageHandlerFn：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> onMessageHandlerFn <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">self.onmessage = ({ data: { data } }) =&gt; {
      console.log('Message received from main script');
      const {method} = data;
      if (data.data &amp;&amp; method === 'format') {
        self.postMessage({
          data: formatFn(data.data)
        });
      }
      console.log('Posting message back to main script');
}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><p>利用 Promise 的链式调用，我们可以隐藏较为琐碎的事件监听处理程序。来写一个 send 方法允许开发者动态调用，内部我们接收到数据后，改变 resolve 的状态，并返回这个 Promise：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>worker<span class="token punctuation">;</span>
    w<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>resolve <span class="token operator">=</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们定义一个 this.resolve 用于记录 Promise 的状态，然后在 Worker 收到响应后便判断 this.resolve 然后决定是否 resolve 计算结果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">handleResult</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolve <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>如此一来，接下来我们就可以在主进程中这样调用 DynamicWorker 了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> DataWorker <span class="token keyword">from</span> <span class="token string">&quot;./dynamicWorker.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">formatFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">res</span><span class="token operator">:</span> <span class="token string">&quot;I am a customized result string.&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataWorker</span><span class="token punctuation">(</span>formatFunc<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// demo 数据</span>

worker
  <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&quot;format&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> result<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Response: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="调用区分优化"><a href="#调用区分优化" class="header-anchor">#</a> 调用区分优化</h3> <p>当然，如果我们没有频繁调用 Worker，那么上面的代码貌似已经足够。但如果你需要短时间多次传输数据进行处理，那么调用的多个方法与对应的多个结果间可能会相互混淆。为什么呢，原因在于我们在构造函数中写的这行：</p> <p>this.worker.addEventListener('message', handleResult);
这个事件监听处理函数是区分不出每次调用的，在收到消息后它只会执行 resolve。那么该如何解决呢？其实也较为简单，加入一个标志位用于区分不同调用即可。</p> <p>首先，在构造函数里我们加上这么一行：</p> <p><code>this.flagMapping = {};</code></p> <p>简单起见，我们直接取日期作为标志位 key，改写后的 send 方法长成这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>worker<span class="token punctuation">;</span>
    <span class="token keyword">const</span> flag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    w<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token punctuation">,</span>
      flag<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>flagMapping<span class="token punctuation">[</span>flag<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后，根据 flag 传参我们改写 Worker 内部的 onmessage 函数以及返回结果函数的判断逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> onMessageHandlerFn <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">self.onmessage = ({ data: { data, flag } }) =&gt; {
  console.log('Message received from main script');
  const {method} = data;
  if (data.data &amp;&amp; method === 'format') {
    self.postMessage({
      data: formatFn(data.data),
      flag
    });
  }
  console.log('Posting message back to main script');
}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token keyword">const</span> <span class="token function-variable function">handleResult</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> flag <span class="token punctuation">}</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> resolve <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flagMapping<span class="token punctuation">[</span>flag<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flagMapping<span class="token punctuation">[</span>flag<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>至此，一个可动态创建、可复用的 Web Worker 便写完了。</p> <h2 id="对比使用-web-worker-和不使用-web-worker-的性能"><a href="#对比使用-web-worker-和不使用-web-worker-的性能" class="header-anchor">#</a> 对比使用 Web Worker 和不使用 Web Worker 的性能</h2> <h3 id="不使用-web-worker"><a href="#不使用-web-worker" class="header-anchor">#</a> 不使用 Web Worker</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// no-worker</span>

<span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始计算斐波那契数任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">calculateFibonacci</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> n<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">calculateFibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">calculateFibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;完成计算斐波那契数任务,结果：&quot;</span><span class="token punctuation">,</span> <span class="token function">calculateFibonacci</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> end <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;继续主线程，耗时：&quot;</span><span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://pub-a953275fa2c34c18b80fc1f84e3ea746.r2.dev/xiaowo/2023/08/6ca52ba46bc99221938f1564167ed3ec.png" alt=""></p> <h3 id="使用-web-worker"><a href="#使用-web-worker" class="header-anchor">#</a> 使用 Web Worker</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// use-worker</span>
<span class="token keyword">import</span> DataWorker <span class="token keyword">from</span> <span class="token string">&quot;./dynamicWorker.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始计算斐波那契数任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">formatFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">calculateFibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">calculateFibonacci</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">calculateFibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">calculateFibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataWorker</span><span class="token punctuation">(</span>formatFunc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span> <span class="token comment">// demo 数据</span>
worker
  <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&quot;format&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> n<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> res <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> end <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;完成计算斐波那契数任务,结果：&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;完成计算斐波那契数任务,耗时：&quot;</span><span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> end <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;继续主线程，耗时：&quot;</span><span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://pub-a953275fa2c34c18b80fc1f84e3ea746.r2.dev/xiaowo/2023/08/a8a33f98cf71fdf6257b58cae111f88d.png" alt=""></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>关于 Web Worker 的使用，我们往往只局限在demo上，但是当我们能够在工程中动态的创建 Web Worker 的时候我们便可以解决开始时我们提到的问题。</p> <p>同时我们也要注意不要过度的依赖 Web Worker ，并不是所有的场景都适合使用这个API。</p> <h2 id="参考链接"><a href="#参考链接" class="header-anchor">#</a> 参考链接</h2> <ul><li>https://developer.mozilla.org/zh-CN/docs/Web/API/Worker</li> <li>https://caniuse.com/?search=Web%20Worker</li> <li>https://zhuanlan.zhihu.com/p/59981684?hmsr=toutiao.io&amp;utm_medium=toutiao.io</li> <li>https://html.spec.whatwg.org/multipage/workers.html#workers</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/vuepress/assets/js/app.40312837.js" defer></script><script src="/vuepress/assets/js/2.cf1e524c.js" defer></script><script src="/vuepress/assets/js/67.93aa23db.js" defer></script>
  </body>
</html>
